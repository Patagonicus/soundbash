#!/usr/bin/env bash

get_stream_URLs() {
	wget -O - -- "$1" 2>/dev/null | sed -ne '/window\.SC\.bufferTracks\.push/{s/.*uri":"\([^"]*\)".*streamUrl":"\([^"?]*\).*/\2?\1/;p;}'
}

get_page_count() {
	wget -O - -- "$1" 2>/dev/null | grep -o 'page=[0-9]*' | cut -d= -f 2 | sort -g | tail -n 1
}

show_help() {
	cat <<EOF
Usage: soundbash soundcloud_link
This utility extracts all SoundCloud streaming URLs from a given page. It should work with pretty much everything (track URLs, user favorites, searches).

Parameters:
	-h -?		print this help and exit
	-m number	limits the output to a maximum of number pages. Use 0 or a negative number to fetch all results. Default: 10
EOF
}


OPTIND=1
max_pages=10

while getopts ':h?m:' opt; do
	case "$opt" in
		h|\?)
			if [[ -n "$OPTARG" ]]; then
				echo "Invalid option: $OPTARG" >&2
				exit 1
			fi
			show_help
			exit 0
			;;
		m)
			max_pages="$OPTARG"
			;;
	esac
done

shift $((OPTIND - 1))

while (( $# > 0 )); do
	count="$(get_page_count "$1")"
	if [[ -z "$count" ]]; then
		get_stream_URLs "$1" | head -n 1
	else
		if (( max_pages > 0 && count > max_pages )); then
			count="$max_pages"
		fi
		for ((i=1;i<=count;i++)); do
			get_stream_URLs "${1}?page=${i}"
		done
	fi
	shift
done
